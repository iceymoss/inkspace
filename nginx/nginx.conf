# Nginx 反向代理配置

# 后端服务负载均衡（用于博客前端）
upstream backend_servers {
    server backend-1:8081;
    server backend-2:8081;
    server backend-3:8081;
}

# 博客前端：is.iceymoss.com
server {
    listen 80;
    server_name is.iceymoss.com;
    # 允许较大的请求体（图片 / 文件上传），默认只有 1M
    client_max_body_size 30m;

    # 后端 API 代理（优先匹配，负载均衡）
    location /api {
        # 再次显式声明，确保此路径上传不受限制
        client_max_body_size 30m;
        proxy_pass http://backend_servers;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        # 负载均衡配置
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503;
    }

    # 上传文件代理（优先匹配，直接代理到后端，因为文件是共享的）
    location /uploads {
        proxy_pass http://backend-1:8081;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        # 静态文件缓存
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 代理到博客前端容器
    location / {
        proxy_pass http://blog-frontend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# 管理后台：admin.is.iceymoss.com
server {
    listen 80;
    server_name admin.is.iceymoss.com;
    # 管理后台也可能有上传（如头像、图片等）
    client_max_body_size 30m;

    # 管理后台 API 代理（优先匹配）
    location /api {
        client_max_body_size 30m;
        proxy_pass http://admin-backend:8083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 上传文件代理（优先匹配，直接代理到后端）
    location /uploads {
        proxy_pass http://admin-backend:8083;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        # 静态文件缓存
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # 代理到管理后台前端容器
    location / {
        proxy_pass http://admin-frontend:80;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# HTTPS 配置（如果有 SSL 证书，取消注释并配置）
# server {
#     listen 443 ssl http2;
#     server_name is.iceymoss.com;
# 
#     ssl_certificate /etc/nginx/ssl/is.iceymoss.com.cert.pem;
#     ssl_certificate_key /etc/nginx/ssl/is.iceymoss.com.key.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
# 
#     location / {
#         proxy_pass http://blog-frontend:80;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }
# 
# server {
#     listen 443 ssl http2;
#     server_name admin.is.iceymoss.com;
#
#     ssl_certificate /etc/nginx/ssl/admin.is.iceymoss.com.cert.pem;
#     ssl_certificate_key /etc/nginx/ssl/admin.is.iceymoss.com.key.pem;
#     ssl_protocols TLSv1.2 TLSv1.3;
#     ssl_ciphers HIGH:!aNULL:!MD5;
# 
#     location / {
#         proxy_pass http://admin-frontend:80;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto $scheme;
#     }
# }

