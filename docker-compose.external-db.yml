version: '3.8'

# 使用外部数据库的部署配置
# 详细部署说明请参考: docs/DEPLOYMENT.md
#
# 使用方法: docker-compose -f docker-compose.external-db.yml up -d --build
#
# 前提条件：
# 1. 已有 MySQL 和 Redis 服务运行
# 2. 已创建数据库和用户（参考 docs/DEPLOYMENT.md）
# 3. 已配置 config/config.yaml 和 config/admin.yaml 中的数据库连接信息
# 4. 如果使用 Docker 容器，需要将外部容器加入 inkspace-network 网络
# 5. 创建上传文件目录（如果不存在）：
#    sudo mkdir -p /var/www/inkspace/uploads
#    sudo chown -R $USER:$USER /var/www/inkspace/uploads
#    或者根据实际情况修改下面的挂载路径

services:
  backend-1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: inkspace-backend-1
    restart: always
    # 注意：多个实例不映射端口，通过负载均衡访问
    # 注意：使用外部 MySQL/Redis，不需要 depends_on
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - ./config:/app/config
      - /var/www/inkspace/uploads:/app/uploads # 修改为服务器绝对路径，可根据实际情况调整
    networks:
      - inkspace-network

  backend-2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: inkspace-backend-2
    restart: always
    # 注意：多个实例不映射端口，通过负载均衡访问
    # 注意：使用外部 MySQL/Redis，不需要 depends_on
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - ./config:/app/config
      - /var/www/inkspace/uploads:/app/uploads # 修改为服务器绝对路径，可根据实际情况调整
    networks:
      - inkspace-network

  backend-3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: inkspace-backend-3
    restart: always
    # 注意：多个实例不映射端口，通过负载均衡访问
    # 注意：使用外部 MySQL/Redis，不需要 depends_on
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - ./config:/app/config
      - /var/www/inkspace/uploads:/app/uploads # 修改为服务器绝对路径，可根据实际情况调整
    networks:
      - inkspace-network

  admin-backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: inkspace-admin-backend
    restart: always
    command: [ "./admin" ]
    ports:
      - "8083:8083"
    # 注意：使用外部 MySQL/Redis，不需要 depends_on
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - ./config:/app/config
      - /var/www/inkspace/uploads:/app/uploads # 修改为服务器绝对路径，可根据实际情况调整
    networks:
      - inkspace-network

  scheduler:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: inkspace-scheduler
    restart: always
    command: [ "./scheduler" ]
    # 注意：使用外部 MySQL/Redis，不需要 depends_on
    environment:
      - TZ=Asia/Shanghai
    volumes:
      - ./config:/app/config
      - /var/www/inkspace/uploads:/app/uploads # 修改为服务器绝对路径，可根据实际情况调整
    networks:
      - inkspace-network

  blog-frontend:
    build:
      context: ./web/blog
      dockerfile: Dockerfile
    container_name: inkspace-blog-frontend
    restart: always
    # 注意：不直接暴露端口，通过 Nginx 反向代理访问
    depends_on:
      - backend-1
      - backend-2
      - backend-3
    networks:
      - inkspace-network

  admin-frontend:
    build:
      context: ./web/admin
      dockerfile: Dockerfile
    container_name: inkspace-admin-frontend
    restart: always
    # 注意：不直接暴露端口，通过 Nginx 反向代理访问
    depends_on:
      - admin-backend
    networks:
      - inkspace-network

  # Nginx 反向代理（用于子域名访问）
  nginx-proxy:
    image: nginx:alpine
    container_name: inkspace-nginx-proxy
    restart: always
    ports:
      - "80:80"
      - "443:443" # HTTPS 端口（如果有 SSL 证书）
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # 如果有 SSL 证书，取消注释下面这行并配置证书路径
      # - ./nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - blog-frontend
      - admin-frontend
    networks:
      - inkspace-network

networks:
  inkspace-network:
    driver: bridge
    name: inkspace-network
    # 如果网络已存在，取消下面的注释
    # external: true

