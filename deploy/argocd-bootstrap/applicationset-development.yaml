apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: inkspace-development-apps
  namespace: argocd
spec:
  generators:
    - git:
        repoURL: http://127.0.0.1/k8s/k8s-deploy.git
        revision: develop # 开发环境监听 develop 分支
        directories:
          # 扫描 overlays/development 目录
          - path: /deploy/apps/*/overlays/development
  template:
    metadata:
      # 最终尝试：使用 Git Generator 最直接的数组引用 {{path[N]}}
      name: "dev-{{path[2]}}"
      labels:
        environment: development
        project: inkspace
    spec:
      project: default
      source:
        repoURL: http://127.0.0.1/k8s/k8s-deploy.git
        targetRevision: develop # 使用 develop 分支作为源
        path: "{{path}}"
      destination:
        # !!! 关键：部署到你在 ArgoCD 中注册的测试 K3d 集群的名称
        name: k3d-inkspace-dev-cluster
        namespace: inkspace-backend
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
