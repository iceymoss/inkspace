# .gitlab-ci.yml
#
# æµæ°´çº¿è§¦å‘è§„åˆ™ï¼š
# 1. é€‰ä¸­æŒ‡å®šåˆ†æ”¯ï¼Œæ ‡ç­¾æ¨é€è§¦å‘å™¨ï¼šå½“ç¬¦åˆç‰¹å®šæ ¼å¼çš„æ ‡ç­¾è¢«æ¨é€æ—¶è§¦å‘ï¼ˆä¾‹å¦‚ pro-blog-api-v20240101123000ï¼‰

#
# æµæ°´çº¿é˜¶æ®µæè¿°ï¼š
# 1. prepare     : è§£æè§¦å‘ä¿¡æ¯ï¼Œç¡®å®šéƒ¨ç½²ç¯å¢ƒå’Œç›®æ ‡æœåŠ¡
# 2. build       : å¹¶è¡Œæ„å»ºæ¯ä¸ªæœåŠ¡çš„Dockeré•œåƒï¼Œå¹¶æ¨é€åˆ°é•œåƒä»“åº“
# 3. update-config: æ›´æ–°æœ¬é¡¹ç›®deployåˆ†æ”¯çš„deployå‘½ä»¤å¹¶è§¦å‘ ArgoCD åŒæ­¥

# å…¨å±€å˜é‡å®šä¹‰
variables:
  # é¡¹ç›®åŸºæœ¬ä¿¡æ¯
  PROJECT_NAME: "inkspace" # é¡¹ç›®åç§°
  ECR_REGISTRY: "https://hub.docker.com/r" # Docker é•œåƒä»“åº“åœ°å€
  KUBE_NAMESPACE: "inkspace" # å‘½åç©ºé—´
  RNAMESPACE: "iceymoss" # Docker é•œåƒä»“åº“å‘½åç©ºé—´ï¼ˆç”¨æˆ·åï¼‰
  REGISTRY_USERNAME: "iceymoss" # Docker é•œåƒä»“åº“ç”¨æˆ·å
  REGISTRY_PASSWORD: "admin123" # Docker é•œåƒä»“åº“å¯†ç 
  GITOPS_CONFIG_REPO: "127.0.0.1/iceymoss/inkspace.git" # GitOps é…ç½®ä»“åº“åœ°å€
  # æœåŠ¡åˆ—è¡¨å®šä¹‰
  ALL_SERVICES: "blog-api admin-api task blog-web  admin-web"

  # é»˜è®¤é•œåƒæ ‡ç­¾ç­–ç•¥
  IMAGE_TAG_PREFIX: "${CI_COMMIT_REF_NAME//\//-}"

# å®šä¹‰æµæ°´çº¿é˜¶æ®µ
stages:
  - prepare
  - build
  - update-config

# å·¥ä½œæµè§„åˆ™ï¼šæ”¯æŒåˆ†æ”¯æµ‹è¯•å’Œæ ‡ç­¾ç”Ÿäº§é˜¶æ®µéƒ¨ç½²
workflow:
  rules:
    # æ ‡ç­¾è§¦å‘å™¨â€”â€”Proç”¨äºç”Ÿäº§ç¯å¢ƒï¼ŒDevç”¨äºæµ‹è¯•ç¯å¢ƒ
    - if: '$CI_COMMIT_TAG =~ /^(pro|dev)-([a-z-]+)-v[0-9]{14}$/'

# å®šä¹‰å¯é‡å¤ä½¿ç”¨çš„ä½œä¸šæ¨¡æ¿é”šå®šä¹‰
.parse_template: &parse_template
  stage: prepare  # å°†å·¥ä½œé˜¶æ®µå®šä¹‰ä¸ºå‡†å¤‡é˜¶æ®µï¼ˆå‡†å¤‡é˜¶æ®µï¼‰
  image: alpine:latest  # ä½¿ç”¨è½»é‡çº§ Alpine Linux é•œåƒ
  tags:
    - docker  # æŒ‡å®šåœ¨è¿è¡Œå™¨ä¸Šè¿è¡Œï¼Œå¸¦æœ‰ Docker æ ‡ç­¾
  before_script:
    - apk add --no-cache git  # å®‰è£…gitå·¥å…·ï¼ˆAlpineä½¿ç”¨apkåŒ…ç®¡ç†å™¨ï¼‰
  artifacts:
    reports:
      dotenv: build.env  # å…³é”®ï¼šå°†build.envæ–‡ä»¶ä¸­çš„å˜é‡ä¼ é€’ç»™åç»­ä½œä¸š
  interruptible: true  # å…è®¸åœ¨æ–°æµæ°´çº¿å¯åŠ¨æ—¶ä¸­æ–­å½“å‰ä½œä¸š

# æ ‡ç­¾è§£æå·¥ä½œâ€”â€”æ ¸å¿ƒé€»è¾‘ï¼šä»…å¤„ç†æ ‡ç­¾è§¦å‘å™¨ï¼Œæ‹’ç»åˆ†æ”¯è§¦å‘å™¨
parse_trigger:
  <<: *parse_template  # ç»§æ‰¿ä¸Šè¿°å®šä¹‰çš„æ¨¡æ¿é…ç½®
  # æ·»åŠ ä¸€æ¡è§„åˆ™ï¼šåªæœ‰ç¬¦åˆç‰¹å®šæ ¼å¼çš„æ ‡ç­¾æ‰å…è®¸è§¦å‘æ­¤ä»»åŠ¡
  rules:
    - if: '$CI_COMMIT_TAG =~ /^(pro|dev)-([a-z-]+)-v[0-9]{14}$/'  # åªè¿è¡Œä¸æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…çš„æ ‡ç­¾ã€‚
      when: always  # åŒ¹é…æ—¶æ€»æ˜¯è¿è¡Œ
  script:
    - |
      # æ ‡ç­¾æ ¼å¼æ­£åˆ™è¡¨è¾¾å¼ï¼šç¯å¢ƒ-æœåŠ¡åç§°-ç‰ˆæœ¬æ—¶é—´æˆ³
      TAG_PATTERN="^(pro|dev)-([a-z-]+)-v([0-9]{14})$"

      # ç”¨grepéªŒè¯æ ‡ç­¾æ ¼å¼ï¼ˆæ›´å…¼å®¹çš„æ–¹å¼ï¼‰
      if echo "$CI_COMMIT_TAG" | grep -qE "$TAG_PATTERN"; then
        # æå–æ ‡ç­¾çš„å„ä¸ªéƒ¨åˆ†
        DEPLOY_ENV=$(echo "$CI_COMMIT_TAG" | sed -E "s/$TAG_PATTERN/\\1/")  # æå–ç¯å¢ƒ (pro/dev/stag)
        TARGET_SERVICE=$(echo "$CI_COMMIT_TAG" | sed -E "s/$TAG_PATTERN/\\2/")  # æå–æœåŠ¡åç§°
        VERSION_TIMESTAMP=$(echo "$CI_COMMIT_TAG" | sed -E "s/$TAG_PATTERN/\\3/")  # æå–æ—¶é—´

        # è®¾ç½®ç¯å¢ƒå˜é‡
        export TRIGGER_TYPE="tag"  # è§¦å‘ç±»å‹å›ºå®šåœ¨æ ‡ç­¾ä¸Š
        export DEPLOY_ENV="$DEPLOY_ENV"  # éƒ¨ç½²ç¯å¢ƒ (pro-production, dev-development, stag-staging)
        export TARGET_SERVICE="$TARGET_SERVICE"  # ç›®æ ‡æœåŠ¡åç§°
        export VERSION_TIMESTAMP="$VERSION_TIMESTAMP"  # ç‰ˆæœ¬æ—¶é—´æˆ³ 14ä½æ•°å­—

        # æ—¶é—´æ˜¾ç¤ºæ ¼å¼ï¼šYYYY-MM-DD HH:MM:SS
        VERSION_DATE="${VERSION_TIMESTAMP:0:8}"  # æå–æ—¥æœŸéƒ¨åˆ† (YYYYMMDD)
        VERSION_TIME="${VERSION_TIMESTAMP:8:6}"  # æå–æ—¶é—´éƒ¨åˆ† (HHMMSS)
        export VERSION_READABLE="${VERSION_DATE:0:4}-${VERSION_DATE:4:2}-${VERSION_DATE:6:2} ${VERSION_TIME:0:2}:${VERSION_TIME:2:2}:${VERSION_TIME:4:2}"

      else
        exit 1  # å‡ºå£ä»£ç 1è¡¨ç¤ºæ•…éšœï¼Œå¯¼è‡´ç®¡é“åœæ­¢ã€‚
      fi

      # ç¡®å®šå°†è¦å¤„ç†çš„æœåŠ¡èŒƒå›´
      if [ "$TARGET_SERVICE" = "all" ]; then
        # å¦‚æœæœåŠ¡åç§°ä¸ºallï¼Œæ‰€æœ‰æœåŠ¡éƒ½ä¼šè¢«å¤„ç†
        export SERVICES_TO_PROCESS="blog-api admin-api task blog-web  admin-web"
        echo "ğŸ¯ scope of processing all services"
      else
        # å¦åˆ™ï¼Œåªå¤„ç†æŒ‡å®šçš„å•ä¸€æœåŠ¡
        export SERVICES_TO_PROCESS="$TARGET_SERVICE"
        echo "ğŸ¯ processing scope single service - $TARGET_SERVICE"
      fi

      # ä¸º Docker é•œåƒåç§°è®¾ç½®é•œåƒæ ‡ç­¾
      export IMAGE_TAG="${DEPLOY_ENV}-${TARGET_SERVICE}-${VERSION_TIMESTAMP}"
      echo "ğŸ³ mirror tag: $IMAGE_TAG"

      # å°†ç¯å¢ƒå˜é‡å†™å…¥ build.env æ–‡ä»¶(ä¾›åç»­å·¥ä½œä½¿ç”¨)
      {
        echo "TRIGGER_TYPE=$TRIGGER_TYPE"  # è§¦å‘ç±»å‹
        echo "DEPLOY_ENV=$DEPLOY_ENV"  # éƒ¨ç½²ç¯å¢ƒ
        echo "TARGET_SERVICE=$TARGET_SERVICE"  # ç›®æ ‡æœåŠ¡
        echo "SERVICES_TO_PROCESS=$SERVICES_TO_PROCESS"  # å¤„ç†æœåŠ¡åˆ—è¡¨
        echo "IMAGE_TAG=$IMAGE_TAG"  # docker image æ ‡ç­¾
        echo "VERSION_TIMESTAMP=$VERSION_TIMESTAMP"  # ç‰ˆæœ¬æ—¶é—´æˆ³
        echo "VERSION_READABLE=$VERSION_READABLE"  # å¯è¯»ç‰ˆæœ¬æ—¶é—´
      } > build.env
      cat build.env

